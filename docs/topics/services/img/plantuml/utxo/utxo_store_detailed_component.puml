skinparam defaultTextAlignment center
skinparam rectangle {
  BackgroundColor #e6f0ff
  BorderColor #3366cc
  FontColor black
  RoundCorner 10
}
skinparam component {
  BackgroundColor #e6f0ff
  BorderColor #3366cc
  FontColor black
  RoundCorner 10
}
skinparam database {
  BackgroundColor #f2f2f2
  BorderColor #999999
  FontColor black
  RoundCorner 10
}
skinparam shadowing false
skinparam ArrowColor #666666

@startuml UTXO_Store_Component

!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

title UTXO Store - Component Diagram

Container_Boundary(utxo_store, "UTXO Store System") {

Component(store_interface, "Store Interface", "Go Interface", "Defines UTXO store operations: Get, Create, Spend, Freeze, Reassign")

Component(factory, "Store Factory", "Go", "Creates store instances based on configuration")

Component(memory_impl, "Memory Implementation", "Go", "In-memory UTXO storage with concurrent access and block height tracking")

Component(aerospike_impl, "Aerospike Implementation", "Go", "High-performance NoSQL storage with Lua scripts for atomic operations")

Component(sql_impl, "SQL Implementation", "Go", "Relational database storage for PostgreSQL and SQLite")

Component(null_impl, "Null Implementation", "Go", "No-op implementation for testing and benchmarking")

Component(get_batcher, "Get Batcher", "Go", "Batches UTXO retrieval operations for performance")

Component(spend_batcher, "Spend Batcher", "Go", "Batches UTXO spending operations for performance")

Component(outpoint_batcher, "Outpoint Batcher", "Go", "Batches outpoint operations for performance")

Component(increment_batcher, "Increment Batcher", "Go", "Batches block height increment operations")

Component(cleanup_service, "Cleanup Service", "Go", "Manages delete-after-height operations for expired UTXOs")

Component(aerospike_client, "Aerospike Client", "Aerospike Go", "Aerospike database client with connection pooling")

Component(lua_script_manager, "Lua Script Manager", "Aerospike Lua", "Manages Lua scripts for atomic operations")

Component(sql_driver, "SQL Driver", "Go database/sql", "PostgreSQL and SQLite database drivers")

}

Container_Boundary(external_storage, "External Storage") {

ComponentDb(aerospike_database, "Aerospike Database", "Aerospike", "High-performance NoSQL database")

ComponentDb(postgresql_database, "PostgreSQL Database", "PostgreSQL", "Relational database backend")

ComponentDb(sqlite_database, "SQLite Database", "SQLite", "Lightweight database backend")

ComponentDb(memory_storage, "Memory Storage", "RAM", "In-memory storage")

ComponentDb(file_system, "File System", "Filesystem", "External transaction data files")

}

' Core interface relationships

Rel(store_interface, factory, "Created by", "Configuration-based instantiation")

Rel(factory, memory_impl, "Creates", "Memory store instances")

Rel(factory, aerospike_impl, "Creates", "Aerospike store instances")

Rel(factory, sql_impl, "Creates", "SQL store instances")

Rel(factory, null_impl, "Creates", "Null store instances")

' Implementation to backend relationships

Rel(aerospike_impl, aerospike_client, "Uses", "Database operations")

Rel(aerospike_impl, lua_script_manager, "Uses", "Atomic operations")

Rel(sql_impl, sql_driver, "Uses", "Database queries")

' Batch processing relationships

Rel(store_interface, get_batcher, "Enhanced by", "Batch retrieval")

Rel(store_interface, spend_batcher, "Enhanced by", "Batch spending")

Rel(store_interface, outpoint_batcher, "Enhanced by", "Batch outpoint operations")

Rel(store_interface, increment_batcher, "Enhanced by", "Batch height increments")

' Cleanup service relationship

Rel(aerospike_impl, cleanup_service, "Uses", "DAH cleanup operations")

' Database backend relationships

Rel(memory_impl, memory_storage, "Stores in", "Direct memory access")

Rel(aerospike_impl, aerospike_database, "Stores in", "Aerospike protocol")

Rel(sql_impl, postgresql_database, "Stores in", "SQL queries")

Rel(sql_impl, sqlite_database, "Stores in", "SQL queries")

Rel(aerospike_impl, file_system, "Uses", "External transaction data")

SHOW_LEGEND()

@enduml

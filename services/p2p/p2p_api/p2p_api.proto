syntax = "proto3";

option go_package = "./;p2p_api";
import "google/protobuf/empty.proto";

package p2p_api;

message Peer {
  string id = 1;
  string addr = 2;
  string addrLocal = 3;
  string services = 4;
  int64 lastSend = 5;
  int64 lastRecv = 6;
  int64 sendSize = 7;
  int64 recvSize = 8;
  int64 sendMemory = 9;
  bool pauseSend = 10;
  bool unpauseSend = 11;
  uint64 bytesSent = 12;
  uint64 bytesReceived = 13;
  int64 avgRecvBandwidth = 14;
  string assocId = 15;
  string streamPolicy = 16;
  bool inbound = 17;
  int64 connTime = 18;
  int64 pingTime = 19;
  int64 timeOffset = 20;
  uint32 version = 21;
  string subVer = 22;
  int32 startingHeight = 23;
  int32 currentHeight = 24;
  int32 banscore = 25;
  bool whitelisted = 26;
  int64 feeFilter = 27;
  }


  message GetPeersResponse {
    repeated Peer peers = 1;
  }


  message BanPeerRequest {
    string addr = 1;
    int64 until = 2;
}

message BanPeerResponse {
    bool ok = 1;
}

message UnbanPeerRequest {
    string addr = 1;
}

message UnbanPeerResponse {
    bool ok = 1;
}

message IsBannedRequest {
    string ipOrSubnet = 1;
}

message IsBannedResponse {
    bool isBanned = 1;
}

message ListBannedResponse {
    repeated string banned = 1;
}

message ClearBannedResponse {
    bool ok = 1;
}
  
message AddBanScoreRequest {
    string peer_id = 1;
    string reason = 2;
  }

  message AddBanScoreResponse {
    bool ok = 1;
  }

  message ConnectPeerRequest {
    string peer_address = 1; // multiaddr format: /ip4/127.0.0.1/tcp/9005/p2p/12D3KooW...
  }

  message ConnectPeerResponse {
    bool success = 1;
    string error = 2;
  }

  message DisconnectPeerRequest {
    string peer_id = 1; // peer ID to disconnect from
  }

  message DisconnectPeerResponse {
    bool success = 1;
    string error = 2;
  }

  // Catchup metrics reporting messages
  message RecordCatchupAttemptRequest {
    string peer_id = 1;
  }

  message RecordCatchupAttemptResponse {
    bool ok = 1;
  }

  message RecordCatchupSuccessRequest {
    string peer_id = 1;
    int64 duration_ms = 2; // Duration in milliseconds
  }

  message RecordCatchupSuccessResponse {
    bool ok = 1;
  }

  message RecordCatchupFailureRequest {
    string peer_id = 1;
  }

  message RecordCatchupFailureResponse {
    bool ok = 1;
  }

  message RecordCatchupMaliciousRequest {
    string peer_id = 1;
  }

  message RecordCatchupMaliciousResponse {
    bool ok = 1;
  }

  message UpdateCatchupReputationRequest {
    string peer_id = 1;
    double score = 2; // Score between 0-100
  }

  message UpdateCatchupReputationResponse {
    bool ok = 1;
  }

  message UpdateCatchupErrorRequest {
    string peer_id = 1;
    string error_msg = 2;
  }

  message UpdateCatchupErrorResponse {
    bool ok = 1;
  }

  message GetPeersForCatchupRequest {
    // Empty for now, can add filtering params later
  }

  message PeerInfoForCatchup {
    string id = 1;
    int32 height = 2;
    string block_hash = 3;
    string data_hub_url = 4;
    double catchup_reputation_score = 5;
    int64 catchup_attempts = 6;
    int64 catchup_successes = 7;
    int64 catchup_failures = 8;
  }

  message GetPeersForCatchupResponse {
    repeated PeerInfoForCatchup peers = 1;
  }

  // Report valid subtree reception
  message ReportValidSubtreeRequest {
    string peer_id = 1;      // Peer ID that provided the subtree
    string subtree_hash = 2;
  }

  message ReportValidSubtreeResponse {
    bool success = 1;
    string message = 2;
  }

  // Report valid block reception
  message ReportValidBlockRequest {
    string peer_id = 1;      // Peer ID that provided the block
    string block_hash = 2;
  }

  message ReportValidBlockResponse {
    bool success = 1;
    string message = 2;
  }

  // Messages for peer status checking
  message IsPeerMaliciousRequest {
    string peer_id = 1;
  }

  message IsPeerMaliciousResponse {
    bool is_malicious = 1;
    string reason = 2;  // Optional reason why peer is considered malicious
  }

  message IsPeerUnhealthyRequest {
    string peer_id = 1;
  }

  message IsPeerUnhealthyResponse {
    bool is_unhealthy = 1;
    string reason = 2;  // Optional reason why peer is considered unhealthy
    float reputation_score = 3;  // Current reputation score
  }

  // Comprehensive peer information with all registry metadata
  message PeerRegistryInfo {
    string id = 1;
    int32 height = 2;
    string block_hash = 3;
    string data_hub_url = 4;
    int32 ban_score = 5;
    bool is_banned = 6;
    bool is_connected = 7;
    int64 connected_at = 8;  // Unix timestamp
    uint64 bytes_received = 9;
    int64 last_block_time = 10;  // Unix timestamp
    int64 last_message_time = 11;  // Unix timestamp
    bool url_responsive = 12;
    int64 last_url_check = 13;  // Unix timestamp

    // Interaction/catchup metrics
    int64 interaction_attempts = 14;
    int64 interaction_successes = 15;
    int64 interaction_failures = 16;
    int64 last_interaction_attempt = 17;  // Unix timestamp
    int64 last_interaction_success = 18;  // Unix timestamp
    int64 last_interaction_failure = 19;  // Unix timestamp
    double reputation_score = 20;
    int64 malicious_count = 21;
    int64 avg_response_time_ms = 22;
    string storage = 23;
    string client_name = 24;  // Human-readable name of the client
    string last_catchup_error = 25;  // Last error message from catchup attempt
    int64 last_catchup_error_time = 26;  // Unix timestamp of last catchup error
  }

  message GetPeerRegistryResponse {
    repeated PeerRegistryInfo peers = 1;
  }

  // Record bytes downloaded via HTTP from a peer
  message RecordBytesDownloadedRequest {
    string peer_id = 1;          // Peer ID that provided the data
    uint64 bytes_downloaded = 2; // Number of bytes downloaded
  }

  message RecordBytesDownloadedResponse {
    bool ok = 1;
  }

  message GetPeerRequest {
    string peer_id = 1;
  }

  message GetPeerResponse {
    PeerRegistryInfo peer = 1;  // Will be null/empty if peer not found
    bool found = 2;
  }

  // Add new service for peer operations
  service PeerService {
    rpc GetPeers(google.protobuf.Empty) returns (GetPeersResponse) {}
    rpc BanPeer(BanPeerRequest) returns (BanPeerResponse) {}
    rpc UnbanPeer(UnbanPeerRequest) returns (UnbanPeerResponse) {}
    rpc IsBanned(IsBannedRequest) returns (IsBannedResponse) {}
    rpc ListBanned(google.protobuf.Empty) returns (ListBannedResponse) {}
    rpc ClearBanned(google.protobuf.Empty) returns (ClearBannedResponse) {}
    rpc AddBanScore(AddBanScoreRequest) returns (AddBanScoreResponse) {}
    rpc ConnectPeer(ConnectPeerRequest) returns (ConnectPeerResponse) {}
    rpc DisconnectPeer(DisconnectPeerRequest) returns (DisconnectPeerResponse) {}

    // Catchup metrics reporting endpoints
    rpc RecordCatchupAttempt(RecordCatchupAttemptRequest) returns (RecordCatchupAttemptResponse) {}
    rpc RecordCatchupSuccess(RecordCatchupSuccessRequest) returns (RecordCatchupSuccessResponse) {}
    rpc RecordCatchupFailure(RecordCatchupFailureRequest) returns (RecordCatchupFailureResponse) {}
    rpc RecordCatchupMalicious(RecordCatchupMaliciousRequest) returns (RecordCatchupMaliciousResponse) {}
    rpc UpdateCatchupReputation(UpdateCatchupReputationRequest) returns (UpdateCatchupReputationResponse) {}
    rpc UpdateCatchupError(UpdateCatchupErrorRequest) returns (UpdateCatchupErrorResponse) {}
    rpc GetPeersForCatchup(GetPeersForCatchupRequest) returns (GetPeersForCatchupResponse) {}

    // Subtree and block validation reporting
    rpc ReportValidSubtree(ReportValidSubtreeRequest) returns (ReportValidSubtreeResponse) {}
    rpc ReportValidBlock(ReportValidBlockRequest) returns (ReportValidBlockResponse) {}

    // Peer status checking
    rpc IsPeerMalicious(IsPeerMaliciousRequest) returns (IsPeerMaliciousResponse) {}
    rpc IsPeerUnhealthy(IsPeerUnhealthyRequest) returns (IsPeerUnhealthyResponse) {}

    // Get full peer registry data with all metadata
    rpc GetPeerRegistry(google.protobuf.Empty) returns (GetPeerRegistryResponse) {}

    // Record bytes downloaded via HTTP from a peer
    rpc RecordBytesDownloaded(RecordBytesDownloadedRequest) returns (RecordBytesDownloadedResponse) {}

    // Get single peer information by peer ID
    rpc GetPeer(GetPeerRequest) returns (GetPeerResponse) {}
  }
  
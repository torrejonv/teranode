@startuml
skinparam backgroundColor #F0F8FF
skinparam defaultFontColor #333333
skinparam arrowColor #666666

' Define borders for all elements
skinparam entity {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam control {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam participant {
  BorderColor #666666
  BackgroundColor #DDDDDD
}



title UTXO Persister - Block Processing

participant "UTXO Persister Server" as Server
participant "Blockchain Client" as BlockchainClient
participant "Blockchain Store" as BlockchainStore
participant "UTXOSet" as UTXOSet
participant "Block Store" as BlockStore

activate Server
Server -> Server : trigger(source)
Server -> Server : processNextBlock()

alt using BlockchainStore
    Server -> BlockchainStore : GetBestBlockHeader()
else using BlockchainClient
    Server -> BlockchainClient : GetBestBlockHeader()
end

Server -> Server : maxHeight = bestBlockMeta.Height - 100

alt s.lastHeight >= maxHeight
    Server -> Server : Wait for 100 confirmations\n(return 1 minute delay)
else s.lastHeight < maxHeight
    alt using BlockchainStore
        Server -> BlockchainStore : GetBlockHeadersFromHeight(s.lastHeight + 1)
    else using BlockchainClient
        Server -> BlockchainClient : GetBlockHeadersFromHeight(s.lastHeight + 1)
    end

    Server -> Server : verifyLastSet()
    Server -> Server : consolidator = NewConsolidator()
    Server -> consolidator : ConsolidateBlockRange(startBlock, endBlock)
    activate consolidator
    loop for each block in range
        consolidator -> BlockStore : GetUTXODeletionsReader(blockID)
        consolidator -> BlockStore : GetUTXOAdditionsReader(blockID)
        consolidator -> consolidator : Process deletions and additions
    end
    consolidator --> Server : Return consolidated data
    deactivate consolidator

    Server -> UTXOSet : CreateUTXOSet(consolidator, baseHash)
    activate UTXOSet
    UTXOSet -> BlockStore : GetUTXOSetReader(baseHash)
    UTXOSet -> UTXOSet : Apply consolidator changes
    UTXOSet -> BlockStore : Write new UTXO set
    UTXOSet --> Server : UTXO set created
    deactivate UTXOSet

    Server -> BlockStore : Delete previous block's UTXOSet\n(if skipDeletePreviousBlock is false)
    Server -> Server : writeLastHeight(s.lastHeight)
    Server -> Server : Trigger next block processing
end

deactivate Server

left footer Last Modified On: %date("dd-MMM-yyyy")

@enduml

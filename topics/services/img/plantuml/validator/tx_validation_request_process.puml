@startuml
skinparam backgroundColor #F0F8FF
skinparam defaultFontColor #333333
skinparam arrowColor #666666

' Define borders for all elements
skinparam entity {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam control {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam participant {
  BorderColor #666666
  BackgroundColor #DDDDDD
}



participant "Propagation \n(services/propagation/Server.go)" as Propagation
participant "SubtreeValidation \n(services/subtreevalidation/Server.go)" as SubtreeValidation
participant "Kafka" as Kafka
participant "Validator Server \n(services/validator/Server.go)" as ValidatorServer
entity "Validator \n(services/validator/Validator.go)" as Validator
database "UTXO Store" as UTXOStore
participant "Block Assembly" as BlockAssembly

== Transaction Propagation ==
Propagation -> Propagation: ProcessTransaction()
activate Propagation
alt Large Transaction (>Kafka limit)
    Propagation -> ValidatorServer: HTTP POST /tx
else Normal Transaction with Kafka
    Propagation -> Kafka: Send to validator topic
else No Kafka configured
    Propagation -> Validator: Validate(ctx, tx, blockHeight)
end
activate Validator
Validator -> UTXOStore: spendUtxos()
Validator -> UTXOStore: CreateInUtxoStore()
alt if blockAssemblyEnabled && addToBlockAssembly
    Validator -> BlockAssembly: Store()
end
Validator --> Propagation: Return validation result
deactivate Validator
deactivate Propagation

== Block Validation ==
SubtreeValidation -> SubtreeValidation: processMissingTransactions()
activate SubtreeValidation
SubtreeValidation -> ValidatorServer: ValidateWithOptions(ctx, tx, blockHeight, options)
activate ValidatorServer
ValidatorServer -> Validator: Validate(ctx, tx, blockHeight, options)
activate Validator
Validator -> UTXOStore: spendUtxos()
Validator -> UTXOStore: CreateInUtxoStore()
alt if blockAssemblyEnabled && addToBlockAssembly
    Validator -> BlockAssembly: Store()
end
Validator --> ValidatorServer: Return txMeta
deactivate Validator
ValidatorServer --> SubtreeValidation: Return txMeta
deactivate ValidatorServer
deactivate SubtreeValidation

left footer Last Modified On: %date("dd-MMM-yyyy")

@enduml

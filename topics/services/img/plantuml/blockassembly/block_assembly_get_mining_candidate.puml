@startuml
skinparam backgroundColor #F0F8FF
skinparam defaultFontColor #333333
skinparam arrowColor #666666

' Define borders for all elements
skinparam entity {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam control {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam participant {
  BorderColor #666666
  BackgroundColor #DDDDDD
}



participant "Miner" as Miner
participant "BlockAssemblyClient" as Client
participant "BlockAssemblyServer" as Server
entity "BlockAssembler" as Assembler
entity "SubtreeProcessor" as SubtreeProc
database "JobStore" as JobStore
participant "BlockchainClient" as BlockchainClient

Miner -> Client : GetMiningCandidate(ctx)
activate Client

Client -> Server : GetMiningCandidate(ctx)
activate Server

Server -> Assembler : GetMiningCandidate(ctx)
activate Assembler

Assembler -> SubtreeProc : GetCompletedSubtreesForMiningCandidate()
activate SubtreeProc
SubtreeProc --> Assembler : return subtrees
deactivate SubtreeProc

Assembler -> Assembler : Calculate coinbaseValue
Assembler -> Assembler : getNextNbits()
note right: Check difficulty adjustment

Assembler -> Assembler : Compute candidate merkle proof
Assembler --> Server : return mining candidate
deactivate Assembler

Server -> JobStore : Set(*id, &subtreeprocessor.Job{...}, jobTTL)
Server -> BlockchainClient : SendNotification(ctx, &blockchain.Notification{Type: NotificationType_MiningOn, ...})

Server --> Client : Return mining candidate
deactivate Server

Client --> Miner : Return mining candidate
deactivate Client

left footer Last Modified On: %date("dd-MMM-yyyy")

@enduml

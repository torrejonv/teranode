@startuml
skinparam backgroundColor #F0F8FF
skinparam defaultFontColor #333333
skinparam arrowColor #666666

' Define borders for all elements
skinparam entity {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam control {
  BorderColor #666666
  BackgroundColor #DDDDDD
}

skinparam participant {
  BorderColor #666666
  BackgroundColor #DDDDDD
}



participant "BlockAssembler" as BA
participant "BlockchainClient" as BC
participant "SubtreeProcessor" as STP
database "SubtreeStore" as SStore
database "UTXOStore" as UTXOStore
entity "Block" as BlockEntity

BA -> BC : GetBlockHeaders(ctx, header.Hash(), uint64(b.maxBlockReorgCatchup))
activate BC
BC --> BA : newChain, _, err
deactivate BC

BA -> BA : Calculate moveForwardBlockHeaders and moveBackBlockHeaders

loop For Each BlockHeader in moveForwardBlockHeaders
    BA -> BC : GetBlock(ctx, blockHeader.Hash())
    activate BC
    BC --> BA : block
    deactivate BC
end

loop For Each BlockHeader in moveBackBlockHeaders
    BA -> BC : GetBlock(ctx, blockHeader.Hash())
    activate BC
    BC --> BA : block
    deactivate BC
end

BA -> STP : Reorg(moveBackBlocks, moveForwardBlocks)
activate STP

loop For Each Block in moveBackBlocks
    STP -> STP : moveBackBlock(ctx, block)
    STP -> UTXOStore : Delete coinbase UTXO
end

loop For Each Block in moveForwardBlocks
    STP -> STP : moveForwardBlock(ctx, block, true)
    STP -> UTXOStore : Process coinbase UTXOs
end

STP -> STP : Announce all subtrees to network
STP -> STP : setTxCount()

STP --> BA : reorg completion
deactivate STP

BA -> BA : Update internal state (bestBlockHeader, bestBlockHeight)
BA -> BA : SetState(ctx)
BA -> BA : setCurrentChain(ctx)

left footer Last Modified On: %date("dd-MMM-yyyy")

@enduml
